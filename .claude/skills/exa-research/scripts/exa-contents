#!/bin/bash
# Get contents for URLs using Exa AI
# Usage: exa-contents <url1> [url2...] [options]

set -e

usage() {
  cat >&2 <<EOF
Usage: exa-contents <url1> [url2...] [options]

Options:
  --text              Include full page text (default: true)
  --no-text           Exclude full page text
  --summary           Include AI-generated summary
  --highlights        Extract relevant highlights
  --context           Return combined context for LLM
  --livecrawl MODE    Crawl mode: never, fallback (default), preferred, always
  --subpages NUM      Number of subpages to crawl
  -h, --help          Show this help

Examples:
  exa-contents "https://example.com/article" --summary
  exa-contents "https://blog.com/post1" "https://blog.com/post2" --context
  exa-contents "https://docs.example.com" --subpages 5
EOF
  exit 1
}

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
  usage
fi

if [ -z "$EXA_API_KEY" ]; then
  echo "Error: EXA_API_KEY not set" >&2
  echo "Run: fetch-secrets" >&2
  exit 1
fi

if [ -z "$1" ]; then
  usage
fi

# Collect URLs first
URLS=()
while [[ $# -gt 0 ]] && [[ ! "$1" =~ ^-- ]]; do
  URLS+=("$1")
  shift
done

if [ ${#URLS[@]} -eq 0 ]; then
  echo "Error: At least one URL is required" >&2
  usage
fi

# Defaults
TEXT="true"
SUMMARY="false"
HIGHLIGHTS="false"
CONTEXT="false"
LIVECRAWL="fallback"
SUBPAGES=""

# Parse options
while [[ $# -gt 0 ]]; do
  case $1 in
    --text) TEXT="true"; shift ;;
    --no-text) TEXT="false"; shift ;;
    --summary) SUMMARY="true"; shift ;;
    --highlights) HIGHLIGHTS="true"; shift ;;
    --context) CONTEXT="true"; shift ;;
    --livecrawl) LIVECRAWL="$2"; shift 2 ;;
    --subpages) SUBPAGES="$2"; shift 2 ;;
    -h|--help) usage ;;
    *) echo "Unknown option: $1" >&2; usage ;;
  esac
done

# Build URLs JSON array
URLS_JSON=$(printf '%s\n' "${URLS[@]}" | jq -R . | jq -s .)

# Build JSON payload
JSON=$(jq -n \
  --argjson urls "$URLS_JSON" \
  --argjson text "$TEXT" \
  --argjson context "$CONTEXT" \
  --arg livecrawl "$LIVECRAWL" \
  '{
    urls: $urls,
    text: $text,
    context: $context,
    livecrawl: $livecrawl
  }')

if [ "$SUMMARY" = "true" ]; then
  JSON=$(echo "$JSON" | jq '. + {summary: {query: ""}}')
fi

if [ "$HIGHLIGHTS" = "true" ]; then
  JSON=$(echo "$JSON" | jq '. + {highlights: {}}')
fi

if [ -n "$SUBPAGES" ]; then
  JSON=$(echo "$JSON" | jq --argjson num "$SUBPAGES" '. + {subpages: $num}')
fi

curl -s "https://api.exa.ai/contents" \
  -H "x-api-key: $EXA_API_KEY" \
  -H "Content-Type: application/json" \
  -d "$JSON"
