#!/bin/bash
# Find similar links using Exa AI
# Usage: exa-similar <url> [options]

set -e

usage() {
  cat >&2 <<EOF
Usage: exa-similar <url> [options]

Options:
  -n, --num NUM          Number of results (default: 10)
  --include-domains D    Comma-separated domains to include
  --exclude-domains D    Comma-separated domains to exclude
  --text                 Include full text in results
  --context              Return combined context for LLM
  -h, --help             Show this help

Examples:
  exa-similar "https://stripe.com" --num 5
  exa-similar "https://openai.com/blog/gpt-4" --text
  exa-similar "https://example.com" --include-domains news.ycombinator.com
EOF
  exit 1
}

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
  usage
fi

if [ -z "$EXA_API_KEY" ]; then
  echo "Error: EXA_API_KEY not set" >&2
  echo "Run: fetch-secrets" >&2
  exit 1
fi

if [ -z "$1" ]; then
  usage
fi

URL="$1"
shift

# Defaults
NUM_RESULTS=10
INCLUDE_DOMAINS=""
EXCLUDE_DOMAINS=""
TEXT="false"
CONTEXT="false"

# Parse options
while [[ $# -gt 0 ]]; do
  case $1 in
    -n|--num) NUM_RESULTS="$2"; shift 2 ;;
    --include-domains) INCLUDE_DOMAINS="$2"; shift 2 ;;
    --exclude-domains) EXCLUDE_DOMAINS="$2"; shift 2 ;;
    --text) TEXT="true"; shift ;;
    --context) CONTEXT="true"; shift ;;
    -h|--help) usage ;;
    *) echo "Unknown option: $1" >&2; usage ;;
  esac
done

# Build JSON payload
JSON=$(jq -n \
  --arg url "$URL" \
  --argjson numResults "$NUM_RESULTS" \
  --argjson text "$TEXT" \
  --argjson context "$CONTEXT" \
  '{
    url: $url,
    numResults: $numResults,
    text: $text,
    context: $context
  }')

# Add optional fields
if [ -n "$INCLUDE_DOMAINS" ]; then
  IFS=',' read -ra DOMAINS <<< "$INCLUDE_DOMAINS"
  JSON=$(echo "$JSON" | jq --argjson domains "$(printf '%s\n' "${DOMAINS[@]}" | jq -R . | jq -s .)" '. + {includeDomains: $domains}')
fi

if [ -n "$EXCLUDE_DOMAINS" ]; then
  IFS=',' read -ra DOMAINS <<< "$EXCLUDE_DOMAINS"
  JSON=$(echo "$JSON" | jq --argjson domains "$(printf '%s\n' "${DOMAINS[@]}" | jq -R . | jq -s .)" '. + {excludeDomains: $domains}')
fi

curl -s "https://api.exa.ai/findSimilar" \
  -H "x-api-key: $EXA_API_KEY" \
  -H "Content-Type: application/json" \
  -d "$JSON"
